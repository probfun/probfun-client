<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>男性身高数据分布分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .description {
            color: #555;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .highlight {
            color: #e74c3c;
            font-weight: bold;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-width: 180px;
        }

        .control-label {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
        }

        .control-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #2563eb;
            border-radius: 8px;
            font-size: 1rem;
            width: 160px;
            text-align: center;
            transition: border-color 0.3s;
        }

        select:focus {
            outline: none;
            border-color: #1d4ed8;
            box-shadow: 0 0 5px rgba(37, 99, 235, 0.5);
        }

        select option {
            text-align: center;
        }

        button {
            padding: 12px 25px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .apply-btn {
            background: #2ecc71;
        }

        .apply-btn:hover {
            background: #27ae60;
        }

        .toggle-btn {
            background: #2ecc71;
        }

        .toggle-btn:hover {
            background: #27ae60;
        }

        .hide-btn {
            background: #e74c3c;
        }

        .hide-btn:hover {
            background: #c0392b;
        }

        .precision-btn {
            background: #f39c12;
        }

        .precision-btn:hover {
            background: #e67e22;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            position: relative;
        }

        .chart-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }

        .data-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .section-title {
            padding: 18px 25px;
            background: #2563eb;
            color: white;
            font-size: 1.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 14px 18px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
            font-size: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .description {
                font-size: 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .chart-controls {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #2563eb;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .bin-info {
            margin-top: 15px;
            text-align: center;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .input-hint {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .comparison-note {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .smoothness-explanation {
            background: #f8f9fa;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 8px 8px 0;
        }

        .smoothness-explanation h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .smoothness-explanation p {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .precision-info {
            background: #e8f4fd;
            border: 1px solid #2563eb;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
        }

        /* 滑动条样式 */
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #2563eb;
            border-radius: 4px;
            outline: none;
        }

        /* Chrome, Safari, Opera滑块样式 */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #ffffff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px #2563eb;
            transition: all 0.3s ease;
        }

        /* Firefox滑块样式 */
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ddd;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* 滑块轨道悬停效果 */
        input[type="range"]:hover {
            background: #2563eb;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <span class="control-label">生成新数据</span>
                <button id="generateBtn">生成数据集</button>
            </div>

            <div class="control-group">
                <span class="control-label">设置区间宽度</span>
                <div class="control-input">
                    <select id="binWidthSelect">
                        <option value="0.5">0.5 cm (极细)</option>
                        <option value="1">1 cm (非常细)</option>
                        <option value="2" selected>2 cm (较细)</option>
                        <option value="3">3 cm (适中)</option>
                        <option value="4">4 cm (较粗)</option>
                        <option value="5">5 cm (粗)</option>
                    </select>
                </div>
                <div class="input-hint">选择合适的区间宽度</div>
            </div>

            <div class="control-group">
                <span class="control-label">数据精度</span>
                <button class="precision-btn" id="precisionBtn">当前: 厘米</button>
                <div class="input-hint">点击切换精度</div>
            </div>

            <div class="control-group">
                <span class="control-label">数据样本个数</span>
                <button id="toggleViewBtn">当前: 100条</button>
            </div>

            <p class="description">基于<span class="highlight">10,000名</span>中国成年男性的模拟身高数据，展示了身高分布的统计特征和可视化分析。</p>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>正在生成数据，请稍候...</p>
        </div>

        <div class="chart-container">
            <div class="chart-controls">
                <button class="toggle-btn" id="showLineBtn">显示折线图</button>
                <button class="hide-btn" id="hideLineBtn">隐藏折线图</button>
            </div>
            <canvas id="heightChart"></canvas>
            <div class="legend" id="chartLegend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(37, 99, 235, 0.7);"></div>
                    <span>频率直方图</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(231, 76, 60, 1);"></div>
                    <span>频率折线图</span>
                </div>
            </div>
            <div class="bin-info" id="binInfo">当前区间宽度: 2 cm | 分组数: 20 | 折线图: 显示 | 精度: 厘米</div>
            <div class="comparison-note" id="comparisonNote">
                提示：当前显示频率直方图，纵坐标为概率密度
            </div>

            <div class="precision-info" id="precisionInfo">
                当前使用厘米精度。切换到毫米精度可以获得更光滑的折线图，特别是当区间宽度较小时。当区间宽度为0.5cm时，请使用毫米精度。
            </div>

            <div class="smoothness-explanation">
                <h3>频率直方图说明</h3>
                <p><strong>频率直方图：</strong>纵坐标显示概率密度，即每个区间的频率除以区间宽度，使得直方图的总面积为1。</p>
                <p><strong>计算公式：</strong>概率密度 = (区间频数 / 总样本数) / 区间宽度</p>
                <p><strong>特点：</strong>频率直方图可以直观地比较不同区间的概率密度，不受区间宽度影响。</p>
                <p><strong>毫米精度优势：</strong>使用毫米精度时，数据更加连续，频率分布更加平滑，能更好地展现正态分布特征。</p>
            </div>
        </div>

        <div class="data-section">
            <div class="section-title">
                <span>数据样本 (前100条)</span>
                <span id="dataCount">显示 100 / 10,000 条记录</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>身高(cm)</th>
                            <th>序号</th>
                            <th>身高(cm)</th>
                            <th>序号</th>
                            <th>身高(cm)</th>
                            <th>序号</th>
                            <th>身高(cm)</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- 数据将通过JavaScript填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>数据可视化分析 | 基于正态分布生成模拟数据 | 生成时间: <span id="currentDate"></span></p>
        </footer>
    </div>

    <script>
        // 生成符合正态分布的随机数（厘米精度）
        function generateNormalRandomCM(mean, stdDev) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            return Math.round(mean + stdDev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v));
        }

        // 生成符合正态分布的随机数（毫米精度）
        function generateNormalRandomMM(mean, stdDev) {
            let u = 0, v = 0;
            while (u === 0) u = Math.random();
            while (v === 0) v = Math.random();
            // 生成毫米精度的数据，保留一位小数
            const value = mean + stdDev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            return Math.round(value * 10) / 10; // 保留一位小数
        }

        // 生成身高数据
        function generateHeightData(count, mean, stdDev, precision) {
            const data = [];
            for (let i = 0; i < count; i++) {
                if (precision === 'cm') {
                    data.push(generateNormalRandomCM(mean, stdDev));
                } else { // mm precision
                    data.push(generateNormalRandomMM(mean, stdDev));
                }
            }
            return data;
        }

        // 创建图表（同时显示频率直方图和频率折线图）
        function createChart(data, binWidth, showLine = true, precision = 'cm') {
            const ctx = document.getElementById('heightChart').getContext('2d');

            // 确定数据范围
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min;
            const totalSamples = data.length;

            // 计算分组数
            const binCount = Math.ceil(range / binWidth);

            // 计算每个区间的频数
            const frequencyCounts = Array(binCount).fill(0);

            // 创建分割点标签（从min到max+binWidth，步长为binWidth）
            const labels = [];
            for (let i = 0; i <= binCount; i++) {
                const splitPoint = min + i * binWidth;
                if (precision === 'cm') {
                    labels.push(Math.round(splitPoint));
                } else {
                    labels.push(splitPoint.toFixed(1));
                }
            }

            // 统计每个区间的频数
            data.forEach(value => {
                const binIndex = Math.floor((value - min) / binWidth);
                if (binIndex >= 0 && binIndex < binCount) {
                    frequencyCounts[binIndex]++;
                }
            });

            // 计算频率（概率密度）
            const frequencies = frequencyCounts.map(count =>
                count / (totalSamples * binWidth)
            );

            // 更新区间信息
            const lineStatus = showLine ? '显示' : '隐藏';
            const precisionText = precision === 'cm' ? '厘米' : '毫米';
            document.getElementById('binInfo').textContent =
                `当前区间宽度: ${binWidth} cm | 分组数: ${binCount} | 折线图: ${lineStatus} | 精度: ${precisionText}`;

            // 更新精度信息
            const precisionInfo = document.getElementById('precisionInfo');
            if (precision === 'cm') {
                precisionInfo.textContent = '当前使用厘米精度。切换到毫米精度可以获得更光滑的折线图，特别是当区间宽度较小时。当区间宽度为0.5cm时，请使用毫米精度。';
            } else {
                precisionInfo.textContent = '当前使用毫米精度。数据更加连续，频率分布曲线更加光滑，特别是当区间宽度较小时。';
            }

            // 销毁现有图表（如果存在）
            if (window.heightChartInstance) {
                window.heightChartInstance.destroy();
            }

            // 创建数据集
            const datasets = [
                // 频率直方图数据集
                {
                    type: 'bar',
                    label: '频率直方图',
                    data: frequencies,
                    backgroundColor: 'rgba(37, 99, 235, 0.7)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 0, // 移除边框
                    barPercentage: 1.0, // 柱体宽度为100%
                    categoryPercentage: 1.0, // 类别宽度为100%
                    order: 2 // 确保直方图在折线图下面
                }
            ];

            // 如果需要显示折线图，添加频率折线图数据集
            if (showLine) {
                datasets.push({
                    type: 'line',
                    label: '频率折线图',
                    data: frequencies,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(231, 76, 60, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1,
                    pointRadius: binWidth > 3 ? 3 : (binWidth > 1 ? 2 : 1),
                    tension: 0, // 设置为0，确保使用直线段连接，不做平滑处理
                    fill: false,
                    order: 1 // 确保折线图在直方图上面
                });
            }

            // 创建新图表
            window.heightChartInstance = new Chart(ctx, {
                type: 'bar', // 基础类型是bar
                data: {
                    labels: labels.slice(0, binCount), // 使用分割点作为标签
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `男性身高频率分布直方图与折线图对比 (n=10,000, ${precision === 'cm' ? '厘米精度' : '毫米精度'})`,
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            display: false // 使用自定义图例
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const start = labels[context.dataIndex];
                                    const end = labels[context.dataIndex + 1];
                                    const frequency = context.raw;
                                    const count = frequencyCounts[context.dataIndex];
                                    return `${context.dataset.label} [${start}-${end}]: ${frequency.toFixed(4)} (${count}人)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '概率密度'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toFixed(4);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `身高分割点 (${precision === 'cm' ? 'cm' : 'cm'})`
                            },
                            offset: true, // 让标签在分割线下方
                            ticks: {
                                maxRotation: 45,
                                callback: function (value, index, values) {
                                    // 显示所有分割点标签
                                    return this.getLabelForValue(value);
                                }
                            },
                            grid: {
                                offset: false // 网格线在分割线位置
                            }
                        }
                    },
                    layout: {
                        padding: {
                            bottom: 20 // 为底部标签留出更多空间
                        }
                    }
                }
            });
        }

        // 填充数据表格
        function populateDataTable(data, count = 100, precision = 'cm') {
            const tableBody = document.getElementById('dataBody');
            tableBody.innerHTML = '';

            const displayCount = Math.min(count, data.length);
            document.getElementById('dataCount').textContent = `显示 ${displayCount} / ${data.length.toLocaleString()} 条记录`;

            const rows = Math.ceil(displayCount / 4);

            for (let i = 0; i < rows; i++) {
                const row = document.createElement('tr');

                for (let j = 0; j < 4; j++) {
                    const index = i + j * rows;
                    if (index < displayCount) {
                        // 序号单元格
                        const indexCell = document.createElement('td');
                        indexCell.textContent = (index + 1).toLocaleString();
                        row.appendChild(indexCell);

                        // 数据单元格
                        const dataCell = document.createElement('td');
                        // 根据精度格式化数据
                        if (precision === 'cm') {
                            dataCell.textContent = data[index];
                        } else {
                            dataCell.textContent = data[index].toFixed(1);
                        }
                        row.appendChild(dataCell);
                    } else {
                        // 填充空单元格
                        row.appendChild(document.createElement('td'));
                        row.appendChild(document.createElement('td'));
                    }
                }

                tableBody.appendChild(row);
            }
        }

        // 设置当前日期
        function setCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
        }

        // 初始化页面
        function init() {
            setCurrentDate();

            // 初始化参数
            window.binWidth = 2;
            window.showLine = true; // 默认显示折线图
            window.precision = 'cm'; // 默认厘米精度
            document.getElementById('binWidthSelect').value = window.binWidth;
            document.getElementById('precisionBtn').textContent = '当前: 厘米';
            document.getElementById('toggleViewBtn').textContent = '当前: 100条';

            // 生成初始数据集
            generateNewDataset();
        }

        // 生成新数据集
        function generateNewDataset() {
            // 显示加载指示器
            document.getElementById('loadingIndicator').style.display = 'block';

            // 使用setTimeout让UI有机会更新
            setTimeout(() => {
                // 生成10000个身高数据
                const heightData = generateHeightData(
                    10000,
                    window.precision === 'cm' ? 171 : 171, // 均值
                    window.precision === 'cm' ? 6 : 6,     // 标准差
                    window.precision                        // 精度
                );

                createChart(heightData, window.binWidth, window.showLine, window.precision);
                populateDataTable(heightData, 100, window.precision);

                // 保存数据到全局变量
                window.heightData = heightData;

                // 隐藏加载指示器
                document.getElementById('loadingIndicator').style.display = 'none';
            }, 100);
        }

        // 切换数据视图
        function toggleDataView() {
            const currentCount = parseInt(document.getElementById('dataCount').textContent.split(' ')[1]);
            const newCount = currentCount === 100 ? 500 : 100;

            // 更新按钮文本，显示当前样本个数
            document.getElementById('toggleViewBtn').textContent = `当前: ${newCount}条`;

            populateDataTable(window.heightData, newCount, window.precision);
        }

        // 显示折线图
        function showLineChart() {
            window.showLine = true;
            if (window.heightData) {
                createChart(window.heightData, window.binWidth, window.showLine, window.precision);
            }
            updateComparisonNote();
        }

        // 隐藏折线图
        function hideLineChart() {
            window.showLine = false;
            if (window.heightData) {
                createChart(window.heightData, window.binWidth, window.showLine, window.precision);
            }
            updateComparisonNote();
        }

        // 切换精度
        function togglePrecision() {
            window.precision = window.precision === 'cm' ? 'mm' : 'cm';
            document.getElementById('precisionBtn').textContent = `当前: ${window.precision === 'cm' ? '厘米' : '毫米'}`;

            // 重新生成数据
            generateNewDataset();
        }

        // 更新提示信息
        function updateComparisonNote() {
            const note = document.getElementById('comparisonNote');
            if (window.showLine) {
                note.textContent = '提示：当前显示频率直方图，纵坐标为概率密度';
            } else {
                note.textContent = '提示：当前仅显示频率直方图，可以点击"显示折线图"来查看频率分布曲线';
            }
        }

        // 应用区间宽度
        function applyBinWidth() {
            const select = document.getElementById('binWidthSelect');
            window.binWidth = parseFloat(select.value); // 改为parseFloat以支持小数

            updateComparisonNote();

            if (window.heightData) {
                createChart(window.heightData, window.binWidth, window.showLine, window.precision);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            init();

            // 添加事件监听器
            document.getElementById('generateBtn').addEventListener('click', generateNewDataset);
            document.getElementById('toggleViewBtn').addEventListener('click', toggleDataView);
            document.getElementById('showLineBtn').addEventListener('click', showLineChart);
            document.getElementById('hideLineBtn').addEventListener('click', hideLineChart);
            document.getElementById('precisionBtn').addEventListener('click', togglePrecision);
            document.getElementById('binWidthSelect').addEventListener('change', applyBinWidth);
        });
    </script>
</body>

</html>